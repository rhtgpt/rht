-- ===== 0_generate_dependents.sql =====
-- Run in SQL*Plus/SQLcl (needs SPOOL). Adjust schema/table if needed.

SET LONG 1000000 LONGCHUNKSIZE 1000000 PAGESIZE 0 LINESIZE 32767 TRIMSPOOL ON FEEDBACK OFF ECHO OFF
SPOOL cim_ofm_smg3_logging_dependents.sql

DECLARE
  h  NUMBER;
  ddl CLOB;

  PROCEDURE print(p CLOB) IS
  BEGIN
    IF p IS NOT NULL THEN
      DBMS_OUTPUT.PUT_LINE(p);
    END IF;
  END;
BEGIN
  -- Configure DBMS_METADATA to include storage, tablespace, etc.
  h := DBMS_METADATA.OPEN('TABLE');

  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SQLTERMINATOR',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'SEGMENT_ATTRIBUTES',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'TABLESPACE',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'CONSTRAINTS',TRUE);
  DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'REF_CONSTRAINTS',TRUE);

  -- Indexes
  ddl := DBMS_METADATA.GET_DEPENDENT_DDL('INDEX','CIM_OFM_SMG3_LOGGING','GD');
  print(ddl);

  -- Constraints (PK/UK/CK; FKs too if any point back from this table)
  ddl := DBMS_METADATA.GET_DEPENDENT_DDL('CONSTRAINT','CIM_OFM_SMG3_LOGGING','GD');
  print(ddl);

  -- Triggers (if any)
  ddl := DBMS_METADATA.GET_DEPENDENT_DDL('TRIGGER','CIM_OFM_SMG3_LOGGING','GD');
  print(ddl);

  -- Grants
  ddl := DBMS_METADATA.GET_DEPENDENT_DDL('OBJECT_GRANT','CIM_OFM_SMG3_LOGGING','GD');
  print(ddl);

  -- Comments (table & columns)
  ddl := DBMS_METADATA.GET_DEPENDENT_DDL('COMMENT','CIM_OFM_SMG3_LOGGING','GD');
  print(ddl);

  DBMS_METADATA.CLOSE(h);
END;
/
SPOOL OFF
SET FEEDBACK ON
